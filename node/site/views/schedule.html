<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Brill's Schedule</title>
</head>
	<script src='../codebase/dhtmlxscheduler.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_timeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/jquery-1.6.2.min.js' type='text/javascript' ></script>
	<script src='../codebase/knockout-1.2.1.js' type='text/javascript' ></script>
	<script src='../codebase/kobindinghandlers.js' type='text/javascript' ></script>
	<script src='../codebase/date.format.js' type='text/javascript' ></script>
	<script src='../codebase/stringextension.js' type='text/javascript' ></script>
	<!--
	
	<script src='../../codebase/jquery.tmpl.min.js' type='text/javascript' ></script>
	
	-->
	<link rel='stylesheet' type='text/css' href='../codebase/dhtmlxscheduler.css'>
	
<style type="text/css" media="screen">
	html, body{
		margin:0px;
		padding:0px;
		height:100%;
		overflow:hidden;
	}	
	.one_line{
		white-space:nowrap;
		overflow:hidden;
		padding-top:5px; padding-left:5px;
		text-align:left !important;
	}
	/* **************  wait window  **************************** */    
	.flashMessage {
		margin: -4em 0px 0px -12em; border-radius: 2em; left: 50%; top: 50%; width: 24em; height: 8em; 
		text-align: center; color: rgb(255, 255, 255); line-height: 8em; font-size: 1.25em; font-weight: bold; 
		position: absolute; z-index: 10000; background-color: rgba(0, 0, 0, 0.75); text-shadow: black 1px 1px 3px;
	}
	/* **************  /wait window  **************************** */    
	
	.hidden {
		display: none;
	}
</style>


<body>
	<button data-bind="click: search">Load Airings</button>
	<div class="flashMessage hidden" data-bind="fadeVisible:{condition: viewModel.isBusy, speed:250}, text: viewModel.busyMessage"></div>
	<div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%;'>
		<div class="dhx_cal_navline">
			<div class="dhx_cal_prev_button">&nbsp;</div>
			<div class="dhx_cal_next_button">&nbsp;</div>
			<div class="dhx_cal_today_button"></div>
			<div class="dhx_cal_date"></div>
			<div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div>
			<div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div>
			<div class="dhx_cal_tab" name="timeline_tab" style="right:280px;"></div>
			<div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div>
		</div>
		<div class="dhx_cal_header">
		</div>
		<div class="dhx_cal_data">
		</div>		
	</div>
</body>


<script type="text/javascript">
	var viewModel = {

		// Busy indicators
        busyMessage: ko.observable(''),
        isBusy: ko.observable(false),

		interval: 30, // minutes per column
		start: function(firstHourOfSchedule){ //start:  first time to show
			
			var firstHour = firstHourOfSchedule == undefined
				? new Date().getHours() 
				: firstHourOfSchedule;
				
			return firstHour * (60 / viewModel.interval);
		},
		
        getSectionsURL: '../../networks',
		
		getSearchURL: function(){
			var schedulerState = scheduler.getState();
			/*  TW 12/6/2011 - added from doc 
				mode — current scheduler's mode, e.g. “week”, “month”
				date — current date which is shown in scheduler
				min_date — events are rendered from this date on the current view
				max_date — events are rendered till this date on the current view
				editor_id — editor id if it is present
				lightbox_id — lightbox id if it is present
			*/
			
			var startDate =  schedulerState.min_date.toISO();
			var endDate = schedulerState.max_date.toISO();
			var path = "../../schedules/schedule?startdate='{0}'&enddate='{1}'"
				.format(startDate, endDate);
				
			return path;
		},
		

		sections: ko.observableArray([]),

        // selected criteria
        startDate: ko.observable(new Date(2011, 11, 2, 0, 0, 0, 0)),
        airings: ko.observableArray([]),

        initialize: function(){
			this.loadSections();
		},
		
		createTimeLine: function(sections) {
			scheduler.locale.labels.timeline_tab = "Timeline"
			scheduler.locale.labels.section_custom="Section";
			scheduler.config.details_on_create=true;
			scheduler.config.details_on_dblclick=true;
			scheduler.config.xml_date="%Y-%m-%d %H:%i";
			
			//===============
			//Configuration
			//===============
			scheduler.createTimelineView({
				name:	"timeline",
				x_unit:	"minute",
				x_date:	"%H:%i",
				x_step:	viewModel.interval,
				x_size: 4,
				x_start: viewModel.start(),
				x_length:	4,
				y_unit:	sections,
				y_property:	"section_id",
				render:"bar"
			});
			
			//===============
			//Data loading
			//===============
			scheduler.config.lightbox.sections=[	
				{name:"description", height:130, map_to:"text", type:"textarea" , focus:true},
				{name:"custom", height:23, type:"select", options:sections, map_to:"section_id" },
				{name:"time", height:72, type:"time", map_to:"auto"}
			]
			
			scheduler.init('scheduler_here',viewModel.startDate(),"timeline");
		},

		loadSections: function () {
			
			viewModel.isBusy(true);
			viewModel.busyMessage("Fetching sections");
			
            $.ajax({
                url: this.getSectionsURL,
                contentType: 'application/json',
                dataType: 'json',
                cache: false,
                success: function (data) {
					viewModel.busyMessage("Initializing sections");
					
					/*
					data = viewModel.filterArrayForTnt(data, function(element){
						return element.Name;
					});
					*/
					
					var mapped = $.isArray( data ) 
					? $.map( data, function( data, i ){
							return { 
								key: data.Code, label: data.Name, nielsenCode: data.NielsenCode, 
								isTurnerIndicator: data.IsTurnerNetwork, remoteIdentifier: data.ScarlettCode
							};
						}) 
					: { key: data.Code, label: data.Name, nielsenCode: data.NielsenCode, 
						isTurnerIndicator: data.IsTurnerNetwork, remoteIdentifier: data.ScarlettCode};			
							
							/* ****** sample commented by tw 12/5/2011 ******
								[
									{key:1, label:"James Smith"},
								];
								
								_id":"4edd2604385eb61f8060ae3f","Name":"ANIML","NielsenCode":null,"IsTurnerNetwork":false,"ScarlettCode":null}
							
							****** /sample commented by tw 12/5/2011 *******/
					viewModel.sections(mapped);
					viewModel.isBusy(false);
                },
                error: function (xhr, status, error) {
					alert(xhr.toString());
					alert(status.toString());
                    alert(error.toString());
					viewModel.isBusy(false);
                }
            });
        },
	
		search: function () {
            //loading drop down values.
            this.busyMessage('Loading airings . . .');
            this.isBusy(true);
            try {
                this.loadAirings();
            } catch (exception) {
                alert("An unexpected error occurred while loading page.  Please try again or contact customer support.");
            }
        },

        loadAirings: function () {
			viewModel.busyMessage("Fetching airings");
            $.ajax({
                url: this.getSearchURL(),
                contentType: 'application/json',
                dataType: 'json',
                cache: false,
                success: function (data) {
					viewModel.busyMessage("Initializing airings");
					
					/*
					data = viewModel.filterArrayForTnt(data, function(element){
						return element.Network;
					});
					*/
					
					var mapped = jQuery.isArray( data ) 
						?	$.map( data, function( data, i ){
								return { 
									start_date: viewModel.formatDate(data.StartDate), end_date: viewModel.formatDate(data.EndDate), 
									text: data.Title.Name, section_id: data.Network, externalId: data.ExternalId, 
									platform: data.Platform, source: data.Source,
									 title: { name: data.Title.Name,
											  seriesName: data.Title.SeriesName,
											  releaseYear: data.Title.ReleaseYear,
											  rating: data.Title.Rating,
											  genre: data.Title.Genre,
											  type: data.Title.Type,
											  storyLine: data.Title.Storyline}}}) 
						: { start_date: data.StartDate, end_date: data.EndDate, text: data.Title.Name, 
							section_id: data.Network, externalId : data.ExternalId, platform: data.Platform, source: data.Source,
							title: { name: data.Title.Name,
									seriesName: data.Title.SeriesName,
									releaseYear: data.Title.ReleaseYear,
									rating: data.Title.Rating,
									genre: data.Title.Genre,
									type: data.Title.Type,
									storyLine: data.Title.Storyline}};			
					
					viewModel.airings(mapped);
					viewModel.isBusy(false);
				},
                error: function (xhr, status, error) {
                    alert(error.toString());
					viewModel.isBusy(false);
                }
            });
        },
		
		filterArrayForTnt: function(array, propery){
			var tempData = [];
			$.each(array, function(i, val){
				if (propery(val) != 'TNT') return;
				tempData.push(val);
			});
			return tempData;
		},
		
		formatDate: function(dateValue){
			var dt = new Date(dateValue);
			return dt;
		},
	};
	
	viewModel.searchCompleted = ko.dependentObservable(function() {
		
		scheduler.clearAll();
		$.each(viewModel.airings(), function(i, val){
			scheduler.addEvent(val);
		});
				
	}, viewModel);
	
	viewModel.sectionsLoaded = ko.dependentObservable(function() {
		//if (viewModel.sections() != undefined && viewModel.sections().length > 0)
			//alert ('loaded' + viewModel.sections().length + '  Id: ' + viewModel.sections()[0].section_id);
		viewModel.createTimeLine(viewModel.sections());
	}, viewModel);
	
	/* sample commented by tw 12/5/2011		
		scheduler.parse([
				{ start_date: "2009-06-30 09:00", end_date: "2009-06-30 12:00", text:"Task A-12458", section_id:1},
			],"json");
	*/
	ko.applyBindings(viewModel);	
	
	$(document).ready(function() {
	  viewModel.initialize();
	});

		</script>