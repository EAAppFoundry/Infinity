<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Brill's Schedule</title>
</head>
	<link rel="Stylesheet" type='text/css' href="../codebase/reset.css" />
	<script src='../codebase/dhtmlxscheduler_debug.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/ext/dhtmlxscheduler_timeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='../codebase/jquery-1.6.2.min.js' type='text/javascript' ></script>
	<script src='../codebase/knockout-1.2.1.js' type='text/javascript' ></script>
	<script src='../codebase/kobindinghandlers.js' type='text/javascript' ></script>
	<script src='../codebase/date.format.js' type='text/javascript' ></script>
	<script src='../codebase/date.js' type='text/javascript' ></script>
	<script src='../codebase/stringextension.js' type='text/javascript' ></script>

	<script src="../codebase/ext/dhtmlxscheduler_tooltip.js"></script>	
	<script src="../codebase/ext/dhtmlxscheduler_key_nav.js"></script>	
	<script src="../codebase/ext/dhtmlxscheduler_expand.js"></script>	
	<script src="../codebase/ext/dhtmlxscheduler_readonly.js"></script>	
 
	<link rel='stylesheet' type='text/css' href='../codebase/dhtmlxscheduler.css'>
	
	<link rel='stylesheet' type='text/css' href='../codebase/themes/dark-hive/jquery.ui.base.css'>
	<link rel='stylesheet' type='text/css' href='../codebase/themes/dark-hive/jquery.ui.core.css'>
	<link rel='stylesheet' type='text/css' href='../codebase/themes/dark-hive/jquery-ui-1.8.16.custom.css'>
	<link rel="Stylesheet" type='text/css' href="../codebase/jquery.timepickr.css" />
	<link rel="Stylesheet" type='text/css' href="../codebase/styles.css" />
	<link rel="Stylesheet" type='text/css' href="../codebase/ui.core.css" />
	<link rel="Stylesheet" type='text/css' href="../codebase/ui.timepickr.css" />
	
	<script type="text/javascript" src="../codebase/jquery.utils.js"></script>
	<script type="text/javascript" src="../codebase/jquery.anchorHandler.js"></script>
	<script type="text/javascript" src="../codebase/jquery.strings.js"></script>
	<script type="text/javascript" src="../codebase/jquery.ui.all.js"></script>   
	<script type="text/javascript" src="../codebase/jquery.timepickr.js"></script> 
	
		
<style type="text/css" media="screen">
	html, body{
		margin:0px;
		padding:0px;
		height:100%;
		min-height:100%;
		overflow:hidden;
	}	
	.one_line{
		white-space:nowrap;
		overflow:hidden;
		padding-top:5px; padding-left:5px;
		text-align:left !important;
	}
	/* **************  wait window  **************************** */    
	.flashMessage {
		margin: -4em 0px 0px -12em; border-radius: 2em; left: 50%; top: 50%; width: 24em; height: 8em; 
		text-align: center; color: rgb(255, 255, 255); line-height: 8em; font-size: 1.25em; font-weight: bold; 
		position: absolute; z-index: 10000; background-color: rgba(0, 0, 0, 0.75); text-shadow: black 1px 1px 3px;
	}
	/* **************  /wait window  **************************** */    
	
	.hidden {
		display: none;
	}
	
	.eventStyle{
		background-color:gray;
		color: white;
		background-color: gray;
		border-color: black;
		height:16px;
		padding-top:3px;
	}
	
	.sectionStyle{
		text-align:left;
		vertical-align:middle;
	}
</style>


<body>
<div id="tabs">
	<ul>
		<li><a href="#tabs-1">Schedule</a></li>
		<li><a href="#tabs-2">Listing</a></li>
	</ul>
	<div id="tabs-1">
		<div class="flashMessage hidden" data-bind="fadeVisible:{condition: viewModel.isBusy, speed:250}, text: viewModel.busyMessage"></div>
		<div id="scheduler_here" class="dhx_cal_container" style='width:100%; min-height:550px;'>
			<div class="dhx_cal_navline" >
				<div class="dhx_cal_prev_button"
					data-bind="click:shiftDayLeft">&nbsp;</div>
				<div class="dhx_cal_next_button"
					data-bind="click:shiftDayLeft">&nbsp;</div>
				<div class="dhx_cal_today_button"
					data-bind="click:shiftToday"></div>
				
				<div style="float:left;right:600px">Display <select data-bind="options:availableTimeFrames, 
					optionsText:'display', value:selectedTimeFrame, bindTimeFrame:selectedTimeFrame()"></select> hours</div>
				
				<div class="dhx_cal_date"></div>
				<div class="dhx_cal_tab" name="day_tab" style="right:204px;display:none"></div>
				<div class="dhx_cal_tab" name="week_tab" style="right:140px;display:none"></div>
				<div class="dhx_cal_tab" name="timeline_tab" style="right:360px;display:none"></div>
				
			
				<div class="dhx_cal_prev_time_button"  data-bind="click: shiftTimeLeft" 
					name="prev_time_tab"  style="float:left;right:330px">&nbsp;</div>
					
				<div name="next_time_interactive" style="float:left; right: 265px;">
					<input id="timestart" type="text" data-bind="value: directTime" style="width:50px;height:70%;text-align:center " ></input> 
				</div>			
				
				<div class="dhx_cal_next_time_button" name="next_time_tab" 
					data-bind="click: shiftTimeRight" style="float:left;right:230px">&nbsp;</div>
				<div class="dhx_cal_tab" name="month_tab" style="right:76px;display:none"></div>
				
			</div>
			<div class="dhx_cal_header">
			</div>
			<div class="dhx_cal_data">
			</div>		
		</div>
	</div>
	<div id="tabs-2">
	test2
	</div>
</div>
		

</body>


<script type="text/javascript">
	var timeFrame = function(intervals, display) {
        this.intervals = intervals;
        this.display = display;    
    };    
	
	var defaultTimeFrame = new timeFrame(4, 2);
	
	var viewModel = {

		// Busy indicators
        busyMessage: ko.observable(''),
        isBusy: ko.observable(false),

		initializing: false,
		
		interval: 30, // minutes per column
		intervals: 6, // number of columns
		scheduleStartHour: new Date().getHours(),
		shiftTimeInterval: function(){
			return viewModel.selectedTimeFrame().intervals == undefined 
			? 2 
			: Math.ceil(viewModel.selectedTimeFrame().intervals / 4);
		},
		
		directTime: ko.observable(),
		
		selectedTimeFrame: ko.observable(),
		availableTimeFrames: ko.observableArray([
			defaultTimeFrame,
			new timeFrame(6, 3),
			new timeFrame(8, 4),
			new timeFrame(10, 5),
			new timeFrame(12, 6),
        ]),
		
		
		
		start: function(){ //start:  first time to show
			return viewModel.scheduleStartHour * (60 / viewModel.interval);
		},
		
        getSectionsURL: '../../networks/images',
		
		getSearchURL: function(){
			var schedulerState = scheduler.getState();
			/*  TW 12/6/2011 - added from doc 
				mode — current scheduler's mode, e.g. “week”, “month”
				date — current date which is shown in scheduler
				min_date — events are rendered from this date on the current view
				max_date — events are rendered till this date on the current view
				editor_id — editor id if it is present
				lightbox_id — lightbox id if it is present
			*/
			
			var startDate =  schedulerState.min_date.toISO();
			var endDate = schedulerState.max_date.toISO();
			var path = "../../schedules/startdate/'{0}'/enddate/'{1}'"
				.format(startDate, endDate);
				
			return path;
		},
		

		sections: ko.observableArray([]),

        // selected criteria
        startDate: new Date(2011, 11, 2, 0, 0, 0, 0),
        airings: ko.observableArray([]),

        initialize: function(){
			this.loadSections();
			this.directTime(viewModel.scheduleStartHour + ":00");
		},
		
		createTimeLine: function(sections) {
			scheduler.locale.labels.timeline_tab = "Timeline"
			scheduler.locale.labels.section_custom="Section";
			scheduler.config.details_on_create=true;
			scheduler.config.details_on_dblclick=true;
			scheduler.config.xml_date="%Y-%m-%d %H:%i";
			scheduler.config.readonly_form = true;
			
			//===============
			//Configuration
			//===============
			scheduler.createTimelineView({
				name:	"timeline",
				x_unit:	"minute",
				x_date:	"%H:%i",
				x_step:	viewModel.interval,
				x_size: viewModel.intervals,
				x_start: viewModel.start(),
				y_unit:	sections,
				y_property:	"section_id",
				render:"bar",
				section_autoheight : false,
				dy: "25"
			});

			scheduler.templates.timeline_scale_label = function(section_id, section_label, section_options){
				return (section_options.Url == 'NaN' || section_options.Url == '')
					? "<label style='margin-left:35px;position:relative;'>" + section_label + "</label>"
					: "<img src='" + section_options.Url + 
					  "' height='20px' width='30px'/>&nbsp;&nbsp;<label style='position:relative;bottom:5px'>" + 
					  section_label+"</label>";
			};
			
			scheduler.templates.timeline_scaley_class = function(){
				return "sectionStyle";
			};
			
			scheduler.templates.event_class = function(){
				return 'eventStyle';
			};
			
			scheduler.templates.tooltip_text = function(start,end,event) {
				return "<b><u>"+event.text+"</u></b>"+
					"<br/><b>Series:</b> "+event.title.seriesName+
					"<br/><b>Release Year:</b> "+event.title.releaseYear+
					"<br/><b>Rating:</b> "+event.title.rating+
					"<br/><b>Genre:</b> "+event.title.genre+
					"<br/><b>Platform:</b> "+event.platform+
					"<br/><b>Source:</b> "+event.source+
					"<br/><b>Type:</b> "+event.title.type+
					"<br/><b>Network:</b> "+event.section_id+
					"<br/><b>External Id:</b> "+event.externalId+
					"<br/><b>Start:</b> "+event.start_date.format()+
					"<br/><b>End:</b> "+event.end_date.format()+
					"<br/><b>Story Line:</b> "+event.title.storyLine ;
			};
			
			dhtmlXTooltip.config.className = 'dhtmlXTooltip tooltip'; // sets the CSS classname of the tooltip window
			dhtmlXTooltip.config.timeout_to_display = 50; // delay of the rendering
			dhtmlXTooltip.config.delta_x = 15; // X position relative to the cursor (positive - margin to the right, negative - to the left)
			dhtmlXTooltip.config.delta_y = -20; // Y position relative to the cursor (positive - above the cursor, negative - below)
			
			//===============
			//Data loading
			//===============
			scheduler.config.lightbox.sections=[	
				{name:"description", height:130, map_to:"text", type:"textarea" , focus:true},
				{name:"custom", height:23, type:"select", options:sections, map_to:"section_id" },
				{name:"time", height:72, type:"time", map_to:"auto"},
				{name:"platform", height:72, type:"textarea", map_to:"platform"}
			]
			
			scheduler.init('scheduler_here',viewModel.startDate,"timeline");
			//console.log('create time line');
		},
		
		shiftDayLeft: function(){
			this.shiftDay(-1);
		},
		
		shiftDayRight: function(){
			this.shiftDay(1);
		},
		
		shiftDay: function(shift){
			this.busyMessage("Fetching airings");
			this.isBusy(true);
			
			var workingDate = viewModel.startDate;
			workingDate.add(shift).days();
			viewModel.startDate = workingDate;
			viewModel.createTimeLine(viewModel.sections());
			
			viewModel.search();
		},
		
		shiftTimeLeft: function(){
			this.shiftTime(-this.shiftTimeInterval());
		},
		
		shiftTimeRight: function(){
			this.shiftTime(this.shiftTimeInterval());
		},
		
		shiftTime: function(shift){
			this.busyMessage("Fetching airings");
			this.isBusy(true);
			
			var schedulerState = scheduler.getState();
			var dt = schedulerState.min_date.add(shift).hours();
			viewModel.scheduleStartHour = dt.getHours();
			viewModel.startDate = dt;
			
			viewModel.createTimeLine(viewModel.sections());
			
			viewModel.search();
		},
		
		shiftToday: function(){
			this.busyMessage("Fetching airings");
			this.isBusy(true);
			
			viewModel.startDate = new Date();
			viewModel.createTimeLine(viewModel.sections());
			
			viewModel.search();
		},
		
		loadSections: function () {
			
			viewModel.isBusy(true);
			viewModel.busyMessage("Fetching sections");
			
            $.ajax({
                url: this.getSectionsURL,
                contentType: 'application/json',
                dataType: 'json',
                cache: false,
                success: function (data) {
					viewModel.busyMessage("Initializing sections");
					
					var mapped = $.isArray( data ) 
					? $.map( data, function( data, i ){
							return { 
								key: data.Code, label: data.Name, nielsenCode: data.NielsenCode, 
								isTurnerIndicator: data.IsTurnerNetwork, remoteIdentifier: data.ScarlettCode, Url: data.LogoUrl
							};
						}) 
					: { key: data.Code, label: data.Name, nielsenCode: data.NielsenCode, 
						isTurnerIndicator: data.IsTurnerNetwork, remoteIdentifier: data.ScarlettCode, Url: data.LogoUrl};			
							
					viewModel.sections(mapped);
                },
                error: function (xhr, status, error) {
					alert(xhr.toString());
					alert(status.toString());
                    alert(error.toString());
					viewModel.isBusy(false);
                }
            });
        },
	
		search: function () {
            //loading drop down values.
            viewModel.busyMessage("Fetching airings");
            this.isBusy(true);
            try {
                this.loadAirings();
            } catch (exception) {
                alert("An unexpected error occurred while loading page.  Please try again or contact customer support.");
            }
        },

        loadAirings: function () {
			viewModel.busyMessage("Fetching airings");
			$.ajax({
                url: this.getSearchURL(),
                contentType: 'application/json',
                dataType: 'json',
                cache: false,
                success: function (data) {
					viewModel.busyMessage("Initializing airings");
					console.log("received response" + new Date().toLocaleString());
					var mapped = jQuery.isArray( data ) 
						?	$.map( data, function( data, i ){
								return { 
									start_date: viewModel.formatDate(data.StartDate), end_date: viewModel.formatDate(data.EndDate), 
									text: data.Title.Name, section_id: data.Network, externalId: data.ExternalId, 
									platform: data.Platform, source: data.Source,
									 title: { name: data.Title.Name,
											  seriesName: data.Title.SeriesName,
											  releaseYear: data.Title.ReleaseYear,
											  rating: data.Title.Rating,
											  genre: data.Title.Genre,
											  type: data.Title.Type,
											  storyLine: data.Title.Storyline}}}) 
						: { start_date: data.StartDate, end_date: data.EndDate, text: data.Title.Name, 
							section_id: data.Network, externalId : data.ExternalId, platform: data.Platform, source: data.Source,
							title: { name: data.Title.Name,
									seriesName: data.Title.SeriesName,
									releaseYear: data.Title.ReleaseYear,
									rating: data.Title.Rating,
									genre: data.Title.Genre,
									type: data.Title.Type,
									storyLine: data.Title.Storyline}};			
					
					viewModel.isBusy(false);
					//console.log("adding airings to control" + new Date().toLocaleString());
					viewModel.airings(mapped);
					//console.log("mapped airings to control" + new Date().toLocaleString());
				},
                error: function (xhr, status, error) {
                    alert(error.toString());
					viewModel.isBusy(false);
                }
            });
        },
		
		filterArrayForTnt: function(array, propery){
			var tempData = [];
			$.each(array, function(i, val){
				if (propery(val) != 'TNT') return;
				tempData.push(val);
			});
			return tempData;
		},
		
		formatDate: function(dateValue){
			var dt = new Date(dateValue);
			return "{0} {1}".format(dateFormat(dt, 'isoDate'), dateFormat(dt, 'isoTime'));
		},
		
	};
	
	viewModel.searchCompleted = ko.dependentObservable(function() {
		viewModel.isBusy(false);
		
		scheduler.clearAll();
		scheduler.config.xml_date="%Y-%m-%d %H:%i";

		var airings = viewModel.airings();
		var str = JSON.stringify(airings);
		scheduler.parse(str, "json");
				
	}, viewModel);
	
	viewModel.sectionsLoaded = ko.dependentObservable(function() {
		this.createTimeLine(viewModel.sections());
	}, viewModel);
	
	viewModel.directTimeChange = ko.dependentObservable(function() {
		if (viewModel.directTime() == undefined) return;
		if (viewModel.initializing) return;
		var schedulerState = scheduler.getState();
		var dt =  dateFormat(schedulerState.min_date, 'shortDate') + ' ' + viewModel.directTime();
		console.log('loading direct time');
		viewModel.startDate = new Date(dt);
		
		viewModel.scheduleStartHour = viewModel.startDate.getHours();
		viewModel.createTimeLine(viewModel.sections());
		viewModel.search();
		
	}, viewModel);
	
	ko.bindingHandlers.bindTimeFrame = {
		init: function (element, valueAccessor) {
		},
		update: function (element, valueAccessor) {
			if (viewModel.initializing) return;
			viewModel.initializing = true;
			var value = ko.utils.unwrapObservable(valueAccessor());
			console.log("bind time frame calling search");
			viewModel.intervals = viewModel.selectedTimeFrame().intervals;
			viewModel.createTimeLine(viewModel.sections());
			viewModel.search();
			viewModel.initializing = false;
		}
	};

	ko.applyBindings(viewModel);	
	
	$(document).ready(function() {
	  viewModel.initialize();
	  if (viewModel.initializing) return;
	  viewModel.initializing = true;
	  $( "#tabs" ).tabs();
	  $('#timestart').timepickr({convention:24, rangeMin:['00', '30'] }).focus();
	  search();
	  viewModel.initializing = false;
	});
</script>